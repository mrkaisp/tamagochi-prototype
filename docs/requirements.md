# たまごっちプロトタイプ 要件定義（リファイン版）

本ドキュメントは現行リポジトリのREADME・実装・テストを踏まえ、開発初期段階での要件を整理・明確化したものです。MVPの範囲、非機能要件、未確定事項（要確認）を併記します。

## 1. 目的・スコープ
- 目的: クラシックなたまごっち風のデジタルペット育成ゲームのプロトタイプを実装し、育成ループ・UI・基本操作・自動セーブまでを体験可能にする。
- スコープ（MVP）:
  - ペットの状態（空腹度・幸福度・清潔度・年齢・うんち数・病気状態）の時間経過による変化とUI表示
  - 基本操作（ごはん/あそび/そうじ/くすり）の入力と反映
  - 論理解像度128×128/4倍スケールでのレンダリング（Pygame）
  - 自動セーブ/ロード（30秒間隔 + 終了時）
  - シンプルなデバッグ表示の基盤（表示ON/OFF切替は後続）

除外（MVP外・将来）:
- 成長段階/進化、死活・転生、複数ペット管理、通知機能、サウンド/音楽、ミニゲーム、設定UI、チュートリアル、クラウド同期、アセット多言語切替、ビルド配布（PyInstaller等）。

## 2. 利用者・環境
- ターゲット: 開発チーム/コラボレータ（Mac/Windows/devコンテナで実行・検証）
- 実行環境: Python 3.11 + Pygame 2.5.2、Docker（macOS/Windows向けcomposeあり）、XQuartz/VcXsrvでのGUI転送手順はREADMEに準拠。

## 3. ゲーム仕様（機能要件）

### 3.1 ペット状態モデル（実装準拠）
- フィールド（初期値は `PetStats` 実装より）
  - `hunger: float` 20.0（0=満腹〜100=腹ペコ）
  - `happiness: float` 80.0（0〜100）
  - `cleanliness: float` 80.0（0〜100）
  - `age_seconds: float` 0.0
  - `poop_count: int` 0
  - `is_sick: bool` False
- 自然変化（`config.game`）
  - `hunger_rate` 2.0/秒（空腹増）
  - `happiness_decay` 1.0/秒（幸福減）
  - `cleanliness_decay` 0.5/秒（清潔減）
- 病気判定（いずれか）
  - `hunger >= 85.0` または `cleanliness <= 25.0` または `poop_count > 3`
- アクション効果（`config.game`）
  - ごはん: `hunger -= 35.0`、`poop_count += 1`（最大 `max_poop + 2` まで）
  - あそび: `happiness += 25.0`
  - そうじ: `poop_count = 0`、`cleanliness += 60.0`
  - くすり: `is_sick == True` のときのみ回復（Falseに）
- 表示補助
  - 年齢表示: `age_formatted`（コンパクト）/ `age_digital`（デジタル時計形式）
  - 健康状態ラベル: 「病気/空腹/汚い/悲しい/健康」のいずれか

### 3.2 入力・操作
- キー割り当て（`InputHandler` デフォルト）
  - `1`: ごはん
  - `2`: あそび
  - `3`: そうじ
  - `4`: くすり
  - `ESC`: 終了
  - `P`: 一時停止（現状: 未実装）
  - `F1`: デバッグ（現状: トグル未接続）

### 3.3 UI/レンダリング
- 論理解像度: 128×128 固定（必須）
- 表示スケール: 4倍（512×512）
- FPS: 30
- 主要UI（`UIRenderer`）
  - ステータスバー（おなか/きげん/きれい + アイコン/色変化）
  - ペットスプライト、うんちインジケーター
  - 操作チップス「1:ごはん 2:あそび 3:そうじ」
  - 年齢（デジタル時計）
- デバッグ表示（任意）
  - ステータスの数値を画面左上に列表示

### 3.4 セーブ/ロード
- ファイル: `save/state.json`
- 自動セーブ: 30秒間隔（`config.data.auto_save_interval`）+ 終了時
- ロード: 起動時に存在すれば復元（キー名の後方互換あり）

### 3.5 終了・リセット
- 終了: ESC → セーブ → Pygame終了
- リセット: セーブデータ削除 + 状態初期化（メニューUIは未提供）

## 4. 受け入れ基準（MVP）
- 起動すると128×128論理描画でUIが表示されること。
- 放置すると空腹↑・幸福↓・清潔↓・年齢↑が秒単位で変化すること。
- `1/2/3/4` 入力で各ステータスが仕様どおりに変化すること。
- 病気条件を満たすと `is_sick=True` になり、くすりで回復すること。
- うんち数はごはんで増え、そうじで0に戻ること。
- 30秒ごと/終了時に自動セーブされ、再起動で復元されること。
- 主要ステータスと年齢がUIに表示され、色/インジケータが連動すること。

## 5. 非機能要件
- パフォーマンス: 30 FPS を安定して維持（通常負荷時）
- 表示品質: ピクセルパーフェクト優先、論理座標系は128×128を厳守
- 可搬性: Docker でMac/Windowsの再現可能な実行環境を提供
- ログ/トラブルシュート: 起動/描画/セーブに失敗した場合は標準出力に原因を表示（将来はファイル出力も検討）
- 品質: `tests/` の単体テスト（現状: PetStats）をCIで実行（将来）

## 6. コンフィグ・拡張性
- `src/game/data/config.py` に集約（表示/ゲーム/データ）
- 後続のゲームバランス調整はConfig経由で行い、コード改修を最小化
- 将来的に外部ファイル/環境変数からの上書きも検討

## 7. 既存差分・未実装箇所（現状とREADME差）
- Pause/Debug のトグルは未配線（`InputHandler` はイベント発火のみ）
- 死亡・進化・ゲームオーバーは未実装（`is_alive` は常にTrue）
- サウンド/アニメーション/演出はプレースホルダ（UIは静的）

## 8. リスク・制約
- X11 転送/WindowsのXサーバ設定に依存（表示不可リスク）
- フォント資産（misaki）利用ライセンスの表記/配布方法を要確認
- セーブデータの破損時復旧（現状は単純ロード）

## 9. 要確認事項（オープン質問）
1) MVPでPause/Debugトグルを実装対象に含めますか？（推奨: 含める）
2) 死亡・進化などライフサイクル要素は第2フェーズで良いですか？
3) サウンド（BGM/SE）の導入タイミングは？無音でMVP完了でOK？
4) ミニゲーム（幸福度回復手段の拡張）はMVP外で良いですか？
5) 画面解像度/スケール設定は固定のままか、設定切替を追加しますか？
6) セーブ互換ポリシー（キー変更・マイグレーション方針）の明文化が必要ですか？
7) UI文言/言語は日本語固定で良いですか？英語切り替え要件は？

## 10. ロードマップ（提案）
- フェーズ1（MVP完了）
  - Pause/Debugトグルの実装
  - 主要UI/描画の微調整（当たり判定・配置最適化）
  - セーブ/ロードのエラーハンドリング強化
  - PetStats 以外の軽単体テスト追加（Tamagotchi、Configの基本）
- フェーズ2（体験向上）
  - 簡易アニメーション（ペット/アイコンのステートに応じた差分）
  - 効果音/簡易BGMの追加（ミュート設定含む）
  - 設定メニュー（音量/スケール/キー設定）
- フェーズ3（拡張）
  - 成長/進化/死活、メモリアーカイブ
  - ミニゲーム、イベント、通知
  - 配布パッケージ化（PyInstaller等）

## 11. 参照
- 実装: `src/game/**`、`src/main.py`
- 設定: `src/game/data/config.py`
- テスト: `tests/test_pet_state.py`
- クイックスタート/環境: `README.md`

